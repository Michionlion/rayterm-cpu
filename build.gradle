plugins {
    id 'c'
}

model {
    components {
        rayterm(NativeLibrarySpec)
        rtexplore(NativeExecutableSpec) {
            sources.c.lib library: "rayterm", linkage: link_type
        }
        raytermTest(NativeExecutableSpec) {
            sources {
                c.lib library: "rayterm", linkage: "static"
                c.source.srcDir "src/rayterm/test"
            }
            targetBuildTypes "debug"
        }
    }
    binaries {
        all {
            linker.args "-lncurses"
            if (buildType == buildTypes.debug) {
                cppCompiler.args "-g"
            }
        }
    }
    buildTypes {
        debug
        release
    }
    platforms {
        x64 {
            architecture "x86_64"
        }
    }
    toolChains {
        gcc(Gcc) {
            // Uncomment to use GCC not in PATH
            // path "/usr/bin/gcc"
            eachPlatform {
                cppCompiler.withArguments { args ->
                    args << "-std=c99" << "Wall"
                }
            }
        }
    }
}

task install(type: Copy) {
    dependsOn 'build'
    from 'build/libs/rayterm/shared/release'
    into "${System.getProperty("user.home")}/${install_location}"
}

task raytermTest(type: Exec) {
    commandLine "./build/exe/raytermTest/raytermTest"
}

task test {
    dependsOn "assemble"
    dependsOn "raytermTest"

    mustRunAfter "assemble"
    tasks.findByName('build').dependsOn "test"
    tasks.findByName('raytermTest').mustRunAfter 'assemble'
}
